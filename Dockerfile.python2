# vim:set ft=dockerfile:
FROM debian:stretch
MAINTAINER "cytopia" <cytopia@everythingcli.org>

RUN set -x \
	&& apt-get update \
	&& apt-get install --no-install-recommends --no-install-suggests -y \
		python-apt \
		python-dev \
		python-jmespath \
		python-pip \
		python-setuptools \
		sudo \
	&& rm -rf /var/lib/apt/lists/* \
	&& apt-get purge -y --autoremove \
	&& update-alternatives --install /usr/bin/python python /usr/bin/python2 1

RUN set -x \
	&& pip install wheel \
	&& pip install ansible

# Add user with password-less sudo
RUN set -x \
	&& useradd -m -s /bin/bash cytopia \
	&& echo "cytopia ALL=(ALL) NOPASSWD: ALL" >> /etc/sudoers.d/cytopia

# Copy files
COPY ./ /home/cytopia/ansible
RUN set -x \
	&& chown -R cytopia:cytopia /home/cytopia/ansible

# Switch to user
USER cytopia

# Change working directory
WORKDIR /home/cytopia/ansible


# Ansible Playbook
RUN set -x \
	# Randomize roles to install each time the container is build (each travis run)
	&& ROLES="$( for d in $(/bin/ls roles/); do if [ -d roles/${d} ]; then echo $d; fi done | grep -vE '*-meta$' | sort -R )" \
	\
	# ---- Install playbook ----
	&& ( \
		echo "# ---- Bootstrap ----"; \
		echo "- hosts: all"; \
		echo "  vars:"; \
		echo "    apt_packages:"; \
		echo "      - apt-transport-https"; \
		echo "      - apt-utils"; \
		echo "      - ca-certificates"; \
		echo "      - curl"; \
		echo "      - git"; \
		echo "      - gnupg"; \
		echo "      - software-properties-common"; \
		echo "  roles:"; \
		echo "    - apt-repo-meta"; \
		echo "    - apt-meta"; \
		\
		echo "# ---- Pythonstrap ----"; \
		echo "- hosts: all"; \
		echo "  roles:"; \
		echo "    - python-meta"; \
		\
		echo "# ---- Pre-defined Roles ----"; \
		for r in ${ROLES}; do \
			echo "- hosts: all"; \
			echo "  vars:"; \
			echo "    $(echo $r | sed 's/-/_/g'): 'install'"; \
			echo "  roles:"; \
			echo "    - ${r}"; \
			echo "  tags:"; \
			echo "    - ${r}"; \
		done; \
		\
		echo "# ---- Custom packages ----"; \
		echo "- hosts: all"; \
		echo "  roles:"; \
		echo "    - apt-meta"; \
		\
		echo "# ---- Mime types ----"; \
		echo "- hosts: all"; \
		echo "  roles:"; \
		echo "    - xdg-mime-meta"; \
		\
	) > travis-ci-install.yml \
	&& cat travis-ci-install.yml \
	\
	# ---- Remove playbook ----
	&& ( \
		echo "# ---- (DELETE) Pre-defined Roles ----"; \
		for r in ${ROLES}; do \
			echo "- hosts: all"; \
			echo "  vars:"; \
			echo "    $(echo $r | sed 's/-/_/g'): 'remove'"; \
			echo "  roles:"; \
			echo "    - ${r}"; \
			echo "  tags:"; \
			echo "    - ${r}"; \
		done; \
		\
		echo "# ---- (DELETE) Custom packages"; \
		echo "- hosts: all"; \
		echo "  vars:"; \
		echo "    apt_state: absent"; \
		echo "  roles:"; \
		echo "    - apt-meta"; \
		\
		echo "# ---- (DELETE) Repositories"; \
		echo "- hosts: all"; \
		echo "  vars:"; \
		echo "    apt_repo_state: absent"; \
		echo "  roles:"; \
		echo "    - apt-repo-meta"; \
		\
	) > travis-ci-remove.yml \
	&& cat travis-ci-remove.yml


# Ansible Run
RUN set -x \
	&& ( \
		echo "#!/bin/sh -eux"; \
		echo "cat travis-ci-install.yml"; \
		#echo "cat travis-ci-remove.yml"; \
		\
		echo "if ! set | grep '^extra=' >/dev/null 2>&1; then"; \
		echo "    extra=\"\""; \
		echo "fi"; \
		echo "ansible-playbook -i inventory travis-ci-install.yml --limit \${MY_HOST} \${extra} --diff -v"; \
		echo "apt list --installed"; \
		\
		echo "ansible-playbook -i inventory travis-ci-remove.yml --limit \${MY_HOST} \${extra} --diff -v"; \
		#echo "apt list --installed"; \
	) > run-tests.sh \
	&& chmod +x run-tests.sh

ENTRYPOINT ["./run-tests.sh"]
